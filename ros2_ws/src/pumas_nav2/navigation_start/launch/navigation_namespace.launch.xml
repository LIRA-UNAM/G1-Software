<launch>

  <!-- Arguments -->
  <arg name="use_sim_time" default="false"/>
  <arg name="namespace" default="my_robot"/>
  <arg name="use_namespace" default="false"/>

  <!-- Define conditional prefix -->
  <arg name="ns_prefix" default="/$(var namespace)" if="$(var use_namespace)"/>
  <arg name="ns_prefix" default="" unless="$(var use_namespace)"/>

  <arg name="static_map_file" default="$(find-pkg-share navigation_start)/maps/maps/wrs2020/map.yaml"/>
  <arg name="prohibition_map_file" default="$(find-pkg-share navigation_start)/maps/prohibition_maps/wrs2020/map.yaml"/>

  <!-- Topics (conditionally namespaced) -->
  <arg name="pose_topic" default="/$(var namespace)/pose" if="$(var use_namespace)"/>
  <arg name="cmd_vel_topic" default="/$(var namespace)/omni_base_controller/cmd_vel" if="$(var use_namespace)"/>
  <arg name="laser_scan_topic" default="/$(var namespace)/scan" if="$(var use_namespace)"/>
  <arg name="point_cloud_topic" default="/$(var namespace)/head_rgbd_sensor/depth_registered/rectified_points" if="$(var use_namespace)"/>
  <arg name="bumper_f_topic" default="/$(var namespace)/base_f_bumper_sensor" if="$(var use_namespace)"/>
  <arg name="base_link_name" default="/$(var namespace)/base_link" if="$(var use_namespace)"/>
  <arg name="odom_topic" default="/$(var namespace)/odom" if="$(var use_namespace)"/>
  <arg name="goal_topic" default="/$(var namespace)/move_base_simple/goal" if="$(var use_namespace)"/>

  <arg name="pose_topic" default="/pose" unless="$(var use_namespace)"/>
  <arg name="cmd_vel_topic" default="/omni_base_controller/cmd_vel" unless="$(var use_namespace)"/>
  <arg name="laser_scan_topic" default="/scan" unless="$(var use_namespace)"/>
  <arg name="point_cloud_topic" default="/head_rgbd_sensor/depth_registered/rectified_points" unless="$(var use_namespace)"/>
  <arg name="bumper_f_topic" default="/base_f_bumper_sensor" unless="$(var use_namespace)"/>
  <arg name="base_link_name" default="base_link" unless="$(var use_namespace)"/>
  <arg name="odom_topic" default="odom" unless="$(var use_namespace)"/>
  <arg name="goal_topic" default="/move_base_simple/goal" unless="$(var use_namespace)"/>

  <arg name="use_lidar" default="True"/>
  <arg name="use_sonars" default="False"/>
  <arg name="use_point_cloud" default="True"/>
  <arg name="use_bumper" default="False"/>
  <arg name="use_pot_fields" default="True"/>

  <arg name="cloud_downsampling" default="5"/>
  <arg name="lidar_downsampling" default="1"/>
  <arg name="cloud_points_threshold" default="100"/>
  <arg name="lidar_points_threshold" default="20"/>

  <arg name="mvn_pln_patience" default="True"/>
  
  <arg name="laser_min_x" default="0.17"/>
  <arg name="laser_max_x" default="0.50"/>
  <arg name="laser_min_y" default="-0.25"/>
  <arg name="laser_max_y" default="0.25"/>
  <arg name="laser_min_z" default="0.025"/>
  <arg name="laser_max_z" default="1.00"/>
  <arg name="cloud_min_x" default="0.30"/>
  <arg name="cloud_max_x" default="0.80"/>
  <arg name="cloud_min_y" default="-0.30"/>
  <arg name="cloud_max_y" default="0.30"/>
  <arg name="cloud_min_z" default="0.01"/>
  <arg name="cloud_max_z" default="1.20"/>

  <!-- out of namespace -->
  <!-- Map servers -->
  <node name="static_map_server" 
        pkg="nav2_map_server" 
        exec="map_server" 
        output="screen"
        respawn="true">
    <param name="yaml_filename" value="$(var static_map_file)"/>
    <!-- Comment this remap if you are using not using default localisation -->
    <remap from="/map" to="/nav_map"/>
  </node>

  <node name="prohibition_map_server" 
        pkg="nav2_map_server" 
        exec="map_server" 
        output="screen"
        respawn="true">
    <param name="yaml_filename" value="$(var prohibition_map_file)"/>
    <remap from="/map" to="/fixed_prohibition_layer_map"/>
  </node>

  <node name="lifecycle_manager_map"
        pkg="nav2_lifecycle_manager"
        exec="lifecycle_manager"
        output="screen"
        respawn="true">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="autostart" value="true"/>
    <param name="node_names" value="['static_map_server', 'prohibition_map_server']"/>
  </node>

  <!-- Map Enhancer -->
  <node name="map_enhancer" 
        pkg="augment_gridmap_online" 
        exec="augment_gridmap_online_node" 
        output="screen"
        respawn="true">

    <remap from="point_obstacle" to="/clicked_point"/>
    <param name="obstacle_radius" value="0.05"/>

    <param name="input_map" value="/fixed_prohibition_layer_map"/>
    <remap from="/grid_map/get_augmented_map" to="/prohibition_map"/>
    <remap from="/grid_map/augmented_map" to="/prohibition_layer_map"/>
  </node>


  <!-- in namespace -->

  <!-- Localization  -->
  <!-- Start EMCL2 localization or your own navigation -->
  <node name="emcl2"
        pkg="emcl2"
        exec="emcl2_node"
        namespace="$(var namespace)"
        output="log"
        args="--ros-args --log-level WARN"
        respawn="true">
    <param name="num_particles" value="1000"/>

    <param name="odom_frame_id" value="$(var namespace)/odom"/> 
    <param name="base_frame_id" value="$(var namespace)/base_link"/>
    <param name="footprint_frame_id" value="$(var namespace)/base_footprint"/>
    <param name="global_frame_id" value="map"/>

    <remap from="scan" to="$(var laser_scan_topic)"/>
    <remap from="local_costmap/scan" to="$(var laser_scan_topic)"/>
    <remap from="odom" to="$(var odom_topic)"/>
    <remap from="cmd_vel" to="$(var cmd_vel_topic)"/>
    <remap from="mcl_pose" to="$(var pose_topic)"/>
    <remap from="map" to="/map"/>
  </node>
  
  <!-- Map Augmenters -->
  <node name="map_augmenter" 
        pkg="map_augmenter" 
        exec="map_augmenter_node"
        namespace="$(var ns_prefix)"
        output="screen"
        respawn="true">
    <param name="use_namespace" value="$(var use_namespace)"/>
    
    <param name="laser_scan_topic" value="$(var laser_scan_topic)"/>
    <param name="point_cloud_topic" value="$(var point_cloud_topic)"/>
    <param name="static_map_server" value="/static_map_server/map"/>
    <param name="prohibition_map_server" value="/prohibition_map"/>
    
    <remap from="point_obstacle" to="/clicked_point"/>
    
    <param name="use_lidar" value="$(var use_lidar)"/>
    <param name="use_sonars" value="$(var use_sonars)"/>
    <param name="use_point_cloud" value="$(var use_point_cloud)"/>
    
    <param name="cloud_downsampling" value="$(var cloud_downsampling)"/>
    
    <param name="decay_factor" value="20"/>    
    <param name="inflation_radius" value="0.22"/>
    <param name="cost_radius" value="0.25"/> 

    <param name="laser_max_x" value="$(var laser_max_x)"/>
    <param name="laser_min_x" value="$(var laser_min_x)"/>
    <param name="laser_max_y" value="$(var laser_max_y)"/>
    <param name="laser_min_y" value="$(var laser_min_y)"/>
    <param name="laser_max_z" value="$(var laser_max_z)"/>
    <param name="laser_min_z" value="$(var laser_min_z)"/>

    <param name="cloud_max_x" value="$(var cloud_max_x)"/>
    <param name="cloud_min_x" value="$(var cloud_min_x)"/>
    <param name="cloud_max_y" value="$(var cloud_max_y)"/>
    <param name="cloud_min_y" value="$(var cloud_min_y)"/>
    <param name="cloud_max_z" value="$(var cloud_max_z)"/>
    <param name="cloud_min_z" value="$(var cloud_min_z)"/>

  </node>

  <!-- Path Planner -->
  <node name="path_planner" 
        pkg="path_planner" 
        exec="path_planner_node" 
        namespace="$(var ns_prefix)"
        output="screen"
        respawn="true">
    <param name="use_namespace" value="$(var use_namespace)"/>
    
    <param name="diagonal_paths" value="False"/>
  </node>

  <node name="simple_move"  
        pkg="simple_move"  
        exec="simple_move_node"
        namespace="$(var ns_prefix)"
        output="screen"
        respawn="true">
    <param name="use_namespace" value="$(var use_namespace)"/>
    
    <param name="max_linear_speed" value="0.8"/>
    <param name="max_angular_speed" value="1.25"/>

    <param name="control_alpha" value="0.2"/>
    <param name="control_beta" value="0.8"/>

    <param name="move_head" value="True"/>
    <param name="use_pot_fields" value="$(var use_pot_fields)"/>
    <param name="odom_topic" value="$(var odom_topic)"/> 
    <param name="base_link_name" value="$(var base_link_name)"/>

    <remap from="/cmd_vel" to="$(var cmd_vel_topic)"/>
  </node>

  <!-- Potential Fields -->
  <node name="potential_fields"  
        pkg="potential_fields"  
        exec="potential_fields_node"
        namespace="$(var ns_prefix)"
        output="screen"
        respawn="true">
    <param name="use_namespace" value="$(var use_namespace)"/>
        
    <param name="debug" value="False"/>
    <param name="show_image" value="True"/> 
    <param name="use_pot_fields" value="$(var use_pot_fields)"/>

    <param name="use_lidar" value="$(var use_lidar)"/>
    <param name="use_point_cloud" value="$(var use_point_cloud)"/>

    <param name="laser_max_x" value="$(var laser_max_x)"/>
    <param name="laser_min_x" value="$(var laser_min_x)"/>
    <param name="laser_max_y" value="$(var laser_max_y)"/>
    <param name="laser_min_y" value="$(var laser_min_y)"/>
    <param name="laser_max_z" value="$(var laser_max_z)"/>
    <param name="laser_min_z" value="$(var laser_min_z)"/>

    <param name="cloud_max_x" value="$(var cloud_max_x)"/>
    <param name="cloud_min_x" value="$(var cloud_min_x)"/>
    <param name="cloud_max_y" value="$(var cloud_max_y)"/>
    <param name="cloud_min_y" value="$(var cloud_min_y)"/>
    <param name="cloud_max_z" value="$(var cloud_max_z)"/>
    <param name="cloud_min_z" value="$(var cloud_min_z)"/>

    <param name="laser_pot_fields_d0" value="0.50"/>
    <param name="laser_pot_fields_k_rej" value="0.40"/>

    <param name="cloud_pot_fields_d0" value="0.80"/>
    <param name="cloud_pot_fields_k_rej" value="0.20"/>

    <param name="cloud_downsampling" value="$(var cloud_downsampling)"/>
    <param name="cloud_points_threshold" value="$(var cloud_points_threshold)"/>
    <param name="lidar_points_threshold" value="$(var lidar_points_threshold)"/>

    <param name="point_cloud_topic" value="$(var point_cloud_topic)"/>
    <param name="laser_scan_topic" value="$(var laser_scan_topic)"/>
    <param name="base_link_name" value="$(var base_link_name)"/>

    <remap from="/cmd_vel" to="$(var cmd_vel_topic)"/>
  </node>

  <node name="publish_enable"
        pkg="potential_fields"
        exec="publish_enable.py"
        namespace="$(var namespace)"  
        output="screen"
        respawn="true">
    <param name="use_namespace" value="$(var use_namespace)"/>
  </node>

  <!-- Motion Planner -->
  <node name="mvn_pln"  
        pkg="mvn_pln"  
        exec="mvn_pln_node"  
        namespace="$(var namespace)"  
        output="screen"
        respawn="true">
    <param name="use_namespace" value="$(var use_namespace)"/>
    
    <param name="patience" value="$(var mvn_pln_patience)"/>
    <param name="base_link_name" value="$(var base_link_name)"/>
    
    <remap from="/nav_control/goal" to="$(var goal_topic)"/>
  </node>

  <!-- Hardware Controller -->
  <node name="arm_controller"
        pkg="hardware_controller"
        exec="arm_node"
        output="screen"
        respawn="true">
        <param name="torso_default_pose" value="0.15"/>
        <!--arm_flex, arm_roll, wrist_flex, wrist_roll-->
        <param name="arm_default_pose" value="[-0.26, -1.57, -1.57, 0.0]"/>
  </node>

  <node name="head_controller"
        pkg="hardware_controller"
        exec="head_node"
        output="screen"
        respawn="true">
        <param name="pan_min" value="-3.14" />
        <param name="pan_max" value="1.74" />
        <param name="tilt_min" value="-0.9" />
        <param name="tilt_max" value="0.47" />
  </node>

  <!-- RVIZ2 -->
  <node name="rviz2"
        pkg="rviz2"
        exec="rviz2"
        args="-d $(find-pkg-share navigation_start)/rviz/config.rviz
              --ros-args --log-level rviz2:=warn"
        output="screen"
        />

</launch>
